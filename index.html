<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>OCR â†’ TTS Demo</title>
</head>
<body>
  <h2>OCR â†’ TTS Live</h2>
  <div id="log">Waiting for feedâ€¦</div>

  <script>
    const FEED_URL = "https://poppasmurf.app.n8n.cloud/webhook/tts-feed";
    const OPENAI_KEY = "YOUR_OPENAI_API_KEY"; // ðŸ”‘ Replace with your real key
    let lastId = null;

    async function playTTS(text) {
      const res = await fetch("https://api.openai.com/v1/audio/speech", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + OPENAI_KEY,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: "gpt-4o-mini-tts",
          voice: "verse",
          input: text
        })
      });

      const arrayBuffer = await res.arrayBuffer();
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const buffer = await ctx.decodeAudioData(arrayBuffer);
      const source = ctx.createBufferSource();
      source.buffer = buffer;
      source.connect(ctx.destination);
      source.start();

      document.getElementById("log").innerHTML += "<div>ðŸ”Š Spoke: " + text + "</div>";
    }

    async function pollFeed() {
      try {
        const res = await fetch(FEED_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("Feed HTTP " + res.status);
        const data = await res.json();

        if (data && data.id && data.text && data.id !== lastId) {
          lastId = data.id;
          console.log("ðŸ“¥ New OCR:", data);
          await playTTS(data.text);

          // Optionally: call ack to clear it
          fetch("https://poppasmurf.app.n8n.cloud/webhook/tts-ack?id=" + encodeURIComponent(data.id));
        }
      } catch (err) {
        console.error("Poll error:", err);
      }
    }

    setInterval(pollFeed, 3000); // poll every 3s
  </script>
</body>
</html>
