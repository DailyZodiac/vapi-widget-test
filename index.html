<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OctoBot Livestream Voice Bridge</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
         background:#f7f7f8;margin:0;min-height:100vh}
    header{padding:16px 20px;background:#111;color:#fff;display:flex;gap:12px;align-items:center}
    header button{padding:10px 14px;border:0;border-radius:10px;font-weight:600;cursor:pointer}
    .arm{background:#14B8A6;color:#fff}
    .test{background:#e5e7eb}
    main{padding:20px}
    .status{font-size:14px;color:#444;margin-top:6px}
    .log{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;
         max-width:820px;min-height:120px;white-space:pre-wrap}
  </style>
</head>
<body>

  <header>
    <div style="font-weight:700;font-size:18px;">üéôÔ∏è OctoBot Livestream Voice</div>
    <button id="armBtn" class="arm">Arm Voice (click once)</button>
    <button id="testBtn" class="test">Send Test Line</button>
    <div id="status" class="status">Status: idle</div>
  </header>

  <main>
    <div class="log" id="log">Logs will appear here‚Ä¶</div>
  </main>

  <!-- Vapi Widget UI -->
  <vapi-widget
    public-key="23ec6d15-2e34-4eab-a53f-37caa2df2bc9"
    assistant-id="2a6efbda-d66c-48f3-acc6-ef6a5e819c8e"
    mode="voice"
    theme="light">
  </vapi-widget>

  <!-- Widget embed (needed for <vapi-widget>) -->
  <script src="https://cdn.jsdelivr.net/gh/VapiAI/html-script-tag@latest/dist/assets/index.js"></script>

  <!-- ‚úÖ Vapi SDK for browser (UMD build, must load after embed) -->
  <script src="https://unpkg.com/@vapi-ai/web@latest/dist/index.umd.js"></script>

  <!-- Custom code -->
  <script>
    const CONFIG = {
      PUBLIC_KEY: "23ec6d15-2e34-4eab-a53f-37caa2df2bc9",
      ASSISTANT_ID: "2a6efbda-d66c-48f3-acc6-ef6a5e819c8e",
      N8N_FEED_URL: "https://poppasmurf.app.n8n.cloud/webhook/tts-feed",
      N8N_ACK_URL: "https://poppasmurf.app.n8n.cloud/webhook/tts-ack",
      POLL_MS: 2000
    };

    const logEl = document.getElementById("log");
    const statusEl = document.getElementById("status");
    const armBtn = document.getElementById("armBtn");
    const testBtn = document.getElementById("testBtn");

    function log(...args){
      const line = args.join(" ");
      logEl.textContent += (logEl.textContent ? "\n" : "") + line;
      logEl.scrollTop = logEl.scrollHeight;
      console.log("[VOICE]", ...args);
    }

    // ‚úÖ Check SDK loaded
    if (typeof Vapi === "undefined") {
      log("‚ùå Vapi SDK not loaded");
    } else {
      log("‚úÖ Vapi SDK loaded, ready to init");
    }

    const vapi = new Vapi(CONFIG.PUBLIC_KEY);
    let armed = false;
    let polling = false;
    let lastId = null;

    async function armVoice(){
      log("Arm button clicked");
      if (armed) return;
      armed = true;
      statusEl.textContent = "Status: starting‚Ä¶";
      try {
        await vapi.start(CONFIG.ASSISTANT_ID);
        statusEl.textContent = "Status: armed (ready)";
        log("‚úÖ Voice armed: session started");
        beginPolling();
      } catch(e){
        armed = false;
        statusEl.textContent = "Status: error starting";
        log("‚ùå Failed to start Vapi session:", e);
      }
    }

    function speak(text){
      log("Test button clicked");
      if (!armed){
        log("‚ö†Ô∏è Not armed yet.");
        return;
      }
      if (!text || !text.trim()) return;
      vapi.send({ type:"input_text", text });
      log("‚û°Ô∏è Injected line:", text);
    }

    async function pollOnce(){
      try {
        const res = await fetch(CONFIG.N8N_FEED_URL, { cache:"no-store" });
        if (!res.ok) throw new Error(`Feed HTTP ${res.status}`);
        const data = await res.json();
        if (data && data.id && data.text && data.id !== lastId){
          lastId = data.id;
          log("üì• From n8n:", data);
          speak(data.text);
          if (CONFIG.N8N_ACK_URL){
            fetch(CONFIG.N8N_ACK_URL+"?id="+encodeURIComponent(data.id)).catch(()=>{});
          }
        }
      } catch(e){ log("‚ö†Ô∏è Poll error:", e.message); }
    }

    function beginPolling(){
      if (polling) return;
      polling = true;
      log(`üõ∞Ô∏è Polling every ${CONFIG.POLL_MS}ms`);
      setInterval(pollOnce, CONFIG.POLL_MS);
    }

    armBtn.addEventListener("click", armVoice);
    testBtn.addEventListener("click", () => speak("This is a test line from the livestream bridge."));
  </script>
</body>
</html>
